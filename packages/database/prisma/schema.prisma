// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication and profile
model User {
  id                String    @id @default(cuid())
  email             String    @unique
  name              String?
  passwordHash      String
  emailVerified     Boolean   @default(false)
  avatarUrl         String?
  university        String?
  major             String?
  yearOfStudy       Int?
  subscriptionTier  SubscriptionTier @default(FREE)
  subscriptionEnd   DateTime?

  // Stripe payment integration
  stripeCustomerId      String?   @unique
  stripeSubscriptionId  String?   @unique
  subscriptionStatus    SubscriptionStatus @default(INACTIVE)
  trialEndsAt           DateTime?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  sessions          Session[]
  uploads           Upload[]
  flashcardSets     FlashcardSet[]
  quizzes           Quiz[]
  quizAttempts      QuizAttempt[]
  studySessions     StudySession[]
  notes             Note[]
  concepts          Concept[]
  betaTester        BetaTester?
}

model Session {
  id                String    @id @default(cuid())
  sessionToken      String    @unique
  userId            String
  expires           DateTime
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt         DateTime  @default(now())
}

// Content upload and processing
model Upload {
  id                String    @id @default(cuid())
  userId            String
  fileName          String
  originalName      String              // Original filename from user
  fileType          FileType
  mimeType          String              // e.g., application/pdf, image/png
  fileUrl           String
  fileSize          Int                 // Size in bytes
  processingStatus  ProcessingStatus @default(PENDING)
  processingError   String?             // Error message if processing failed
  extractedText     String?             // Extracted text content
  textLength        Int?                // Character count of extracted text
  pageCount         Int?                // For PDFs/documents
  metadata          Json?               // Additional metadata (course, topic, etc.)
  storageKey        String?             // S3/MinIO storage key
  checksum          String?             // File hash for deduplication
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  processedAt       DateTime?           // When processing completed

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  flashcardSets     FlashcardSet[]
  quizzes           Quiz[]
  notes             Note[]
  concepts          Concept[]

  @@index([userId])
  @@index([processingStatus])
}

// Flashcard system
model FlashcardSet {
  id                String    @id @default(cuid())
  userId            String
  uploadId          String?
  title             String
  description       String?
  isPublic          Boolean   @default(false)
  tags              String[]
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  upload            Upload?   @relation(fields: [uploadId], references: [id], onDelete: SetNull)
  flashcards        Flashcard[]
  studySessions     StudySession[]
}

model Flashcard {
  id                String    @id @default(cuid())
  setId             String
  question          String
  answer            String
  hint              String?
  difficulty        Difficulty @default(MEDIUM)
  timesReviewed     Int       @default(0)
  correctCount      Int       @default(0)
  lastReviewed      DateTime?
  nextReview        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  flashcardSet      FlashcardSet @relation(fields: [setId], references: [id], onDelete: Cascade)
}

// Quiz system
model Quiz {
  id                String    @id @default(cuid())
  userId            String
  uploadId          String?
  title             String
  description       String?
  timeLimit         Int?      // in minutes
  passingScore      Float     @default(70) // percentage
  isPublic          Boolean   @default(false)
  tags              String[]
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  upload            Upload?   @relation(fields: [uploadId], references: [id], onDelete: SetNull)
  questions         Question[]
  attempts          QuizAttempt[]
}

model Question {
  id                String    @id @default(cuid())
  quizId            String
  type              QuestionType
  question          String
  options           Json?     // For MCQ: array of options
  correctAnswer     String
  explanation       String?
  points            Int       @default(1)
  order             Int
  createdAt         DateTime  @default(now())

  quiz              Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers           Answer[]
}

// Study tracking
model QuizAttempt {
  id                String    @id @default(cuid())
  userId            String
  quizId            String
  score             Float
  timeSpent         Int       // in seconds
  completed         Boolean   @default(false)
  startedAt         DateTime  @default(now())
  completedAt       DateTime?

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz              Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers           Answer[]
}

model Answer {
  id                String    @id @default(cuid())
  attemptId         String
  questionId        String
  userAnswer        String
  isCorrect         Boolean
  createdAt         DateTime  @default(now())

  attempt           QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question          Question  @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
}

model StudySession {
  id                String    @id @default(cuid())
  userId            String
  flashcardSetId    String?
  duration          Int       // in seconds
  cardsStudied      Int       @default(0)
  accuracy          Float?
  startedAt         DateTime  @default(now())
  endedAt           DateTime?

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  flashcardSet      FlashcardSet? @relation(fields: [flashcardSetId], references: [id], onDelete: SetNull)
}

// Notes and knowledge graph
model Note {
  id                String    @id @default(cuid())
  userId            String
  uploadId          String?
  title             String
  content           String
  tags              String[]
  isPublic          Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  upload            Upload?   @relation(fields: [uploadId], references: [id], onDelete: SetNull)
  connections       NoteConnection[] @relation("FromNote")
  connectedTo       NoteConnection[] @relation("ToNote")
}

model NoteConnection {
  id                String    @id @default(cuid())
  fromNoteId        String
  toNoteId          String
  relationshipType  String
  strength          Float     @default(1.0)
  createdAt         DateTime  @default(now())

  fromNote          Note      @relation("FromNote", fields: [fromNoteId], references: [id], onDelete: Cascade)
  toNote            Note      @relation("ToNote", fields: [toNoteId], references: [id], onDelete: Cascade)

  @@unique([fromNoteId, toNoteId])
}

// Knowledge Graph - Concepts
model Concept {
  id                String    @id @default(cuid())
  userId            String
  uploadId          String?             // Source upload (lecture/document)
  name              String              // Concept name
  description       String?             // Brief description
  entityType        ConceptEntityType   // Type of entity (PERSON, THEORY, FORMULA, etc.)
  importance        Float     @default(0.5)  // Importance weight (0-1)
  embedding         Float[]             // Vector embedding for semantic search
  metadata          Json?               // Additional metadata (e.g., professor emphasis)
  lectureOrder      Int?                // Order in which concept appeared in lectures
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  upload            Upload?   @relation(fields: [uploadId], references: [id], onDelete: SetNull)

  // Relations for knowledge graph edges
  outgoingRelations ConceptRelationship[] @relation("FromConcept")
  incomingRelations ConceptRelationship[] @relation("ToConcept")

  @@index([userId])
  @@index([uploadId])
  @@index([entityType])
  @@unique([userId, name, uploadId])
}

// Knowledge Graph - Relationships between concepts
model ConceptRelationship {
  id                String    @id @default(cuid())
  fromConceptId     String
  toConceptId       String
  relationshipType  RelationshipType
  strength          Float     @default(1.0)   // Relationship strength (0-1)
  description       String?                   // Optional description of relationship
  bidirectional     Boolean   @default(false) // Whether relationship goes both ways
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  fromConcept       Concept   @relation("FromConcept", fields: [fromConceptId], references: [id], onDelete: Cascade)
  toConcept         Concept   @relation("ToConcept", fields: [toConceptId], references: [id], onDelete: Cascade)

  @@unique([fromConceptId, toConceptId, relationshipType])
  @@index([fromConceptId])
  @@index([toConceptId])
}

// Beta Testing Program Models
model BetaApplication {
  id                String    @id @default(cuid())
  email             String    @unique
  name              String
  university        String
  major             String?
  yearOfStudy       Int?
  studyHoursPerWeek Int?                          // How many hours they study per week
  currentTools      String[]                      // What tools they currently use
  painPoints        String?                       // What problems they face with studying
  referralSource    String?                       // How they heard about StudySync
  status            BetaApplicationStatus @default(PENDING)
  reviewedAt        DateTime?
  reviewedBy        String?                       // Admin who reviewed
  reviewNotes       String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relation to user if they become a beta tester
  betaTester        BetaTester?

  @@index([status])
  @@index([university])
}

model BetaTester {
  id                String    @id @default(cuid())
  userId            String    @unique
  applicationId     String?   @unique
  cohort            String?                       // e.g., "cohort-1", "university-pilot"
  status            BetaTesterStatus @default(ACTIVE)
  joinedAt          DateTime  @default(now())
  lastActiveAt      DateTime  @default(now())
  featuresEnabled   String[]                      // Feature flags enabled for this tester
  notes             String?                       // Internal notes about the tester

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  application       BetaApplication? @relation(fields: [applicationId], references: [id], onDelete: SetNull)
  feedback          BetaFeedback[]

  @@index([cohort])
  @@index([status])
}

model BetaFeature {
  id                String    @id @default(cuid())
  name              String    @unique             // e.g., "ai-flashcards-v2", "quiz-hints"
  description       String?
  isEnabled         Boolean   @default(false)     // Global enable/disable
  rolloutPercentage Int       @default(0)         // % of users who should see this (0-100)
  allowedCohorts    String[]                      // Specific cohorts that can access
  allowedUsers      String[]                      // Specific user IDs that can access
  metadata          Json?                         // Additional configuration
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([isEnabled])
}

model BetaFeedback {
  id                String    @id @default(cuid())
  betaTesterId      String
  userId            String
  type              FeedbackType
  category          FeedbackCategory
  title             String?
  content           String                        // Feedback content
  rating            Int?                          // 1-5 rating if applicable
  npsScore          Int?                          // 0-10 NPS score if applicable
  featureName       String?                       // Which feature the feedback is about
  pageUrl           String?                       // Where the feedback was submitted from
  metadata          Json?                         // Additional context (browser, device, etc.)
  status            FeedbackStatus @default(NEW)
  resolvedAt        DateTime?
  resolvedBy        String?
  resolution        String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  betaTester        BetaTester @relation(fields: [betaTesterId], references: [id], onDelete: Cascade)

  @@index([betaTesterId])
  @@index([type])
  @@index([category])
  @@index([status])
}

model AnalyticsEvent {
  id                String    @id @default(cuid())
  userId            String?                       // Null for anonymous events
  sessionId         String?                       // Browser session ID
  eventType         String                        // e.g., "page_view", "feature_used", "button_clicked"
  eventName         String                        // Specific event name
  properties        Json?                         // Event-specific data
  pageUrl           String?
  referrer          String?
  userAgent         String?
  ipAddress         String?
  country           String?
  city              String?
  deviceType        String?                       // desktop, mobile, tablet
  browser           String?
  os                String?
  createdAt         DateTime  @default(now())

  @@index([userId])
  @@index([eventType])
  @@index([eventName])
  @@index([createdAt])
  @@index([sessionId])
}

// Enums
enum SubscriptionTier {
  FREE
  PREMIUM
  STUDENT_PLUS
  UNIVERSITY
}

enum FileType {
  PDF
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  PRESENTATION
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
}

// Knowledge Graph Entity Types
enum ConceptEntityType {
  PERSON              // Historical figures, scientists, authors
  THEORY              // Scientific theories, hypotheses
  FORMULA             // Mathematical or scientific formulas
  EVENT               // Historical events, experiments
  TERM                // Technical terms, definitions
  PROCESS             // Procedures, methods, workflows
  PRINCIPLE           // Laws, rules, principles
  CONCEPT             // General concepts, ideas
  EXAMPLE             // Examples, case studies
  DATE                // Important dates, time periods
}

// Knowledge Graph Relationship Types
enum RelationshipType {
  PREREQUISITE        // A must be understood before B
  RELATED             // A and B are related concepts
  OPPOSITE            // A and B are contrasting/opposite
  EXAMPLE_OF          // A is an example of B
  PART_OF             // A is a component/part of B
  CAUSES              // A causes or leads to B
  DERIVED_FROM        // A is derived/developed from B
  SIMILAR_TO          // A is similar to B
  APPLIED_IN          // A is applied in B
  SUPPORTS            // A supports/validates B
}

// Beta Testing Program Enums
enum BetaApplicationStatus {
  PENDING             // Waiting for review
  APPROVED            // Approved to join beta
  REJECTED            // Application rejected
  WAITLISTED          // On waiting list
}

enum BetaTesterStatus {
  ACTIVE              // Currently participating
  INACTIVE            // No longer active
  GRADUATED           // Completed beta program
  REMOVED             // Removed from program
}

enum FeedbackType {
  BUG_REPORT          // Bug or issue report
  FEATURE_REQUEST     // Request for new feature
  GENERAL             // General feedback
  NPS_SURVEY          // NPS survey response
  USABILITY           // Usability/UX feedback
  PERFORMANCE         // Performance-related feedback
}

enum FeedbackCategory {
  UPLOAD              // Content upload feature
  FLASHCARDS          // Flashcard generation/study
  QUIZZES             // Quiz system
  UI_UX               // User interface/experience
  PERFORMANCE         // App performance
  AUTHENTICATION      // Login/signup issues
  KNOWLEDGE_GRAPH     // Knowledge graph feature
  OTHER               // Other/miscellaneous
}

enum FeedbackStatus {
  NEW                 // Just submitted
  REVIEWING           // Being reviewed
  IN_PROGRESS         // Being addressed
  RESOLVED            // Issue resolved
  WONT_FIX            // Decided not to address
  DUPLICATE           // Duplicate of another issue
}

// Payment & Subscription Status Enums
enum SubscriptionStatus {
  ACTIVE              // Active subscription
  CANCELED            // Canceled but still active until period end
  PAST_DUE            // Payment failed, retrying
  TRIALING            // In trial period
  INCOMPLETE          // Subscription created but payment incomplete
  INCOMPLETE_EXPIRED  // Payment never completed
  INACTIVE            // No active subscription (default for FREE tier)
}